name: Cleanup Merged Branches

# Automatically deletes feature branches after they're merged to main
# Keeps repository tidy and encourages short-lived branches

on:
  pull_request:
    types:
      - closed

permissions:
  contents: write

jobs:
  delete-branch:
    # Only run if PR was actually merged (not just closed)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Delete merged branch
        env:
          BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
          HEAD_REPO: ${{ github.event.pull_request.head.repo.full_name }}
          BASE_REPO: ${{ github.repository }}
        run: |
          # Don't delete protected branches
          if [[ "$BRANCH_NAME" == "main" ]]; then
            echo "Skipping protected branch: $BRANCH_NAME"
            exit 0
          fi

          # Don't delete branches from forks
          if [[ "$HEAD_REPO" != "$BASE_REPO" ]]; then
            echo "Skipping branch from fork: $BRANCH_NAME"
            exit 0
          fi

          echo "Deleting merged branch: $BRANCH_NAME"
          git push origin --delete "$BRANCH_NAME" || echo "Branch already deleted or doesn't exist"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.payload.pull_request.head.ref;

            // Skip comment for protected branches
            if (branch === 'main') {
              return;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸ§¹ Cleaned up merged branch \`${branch}\``
            });
